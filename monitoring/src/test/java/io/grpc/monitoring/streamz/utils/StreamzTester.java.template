// Copyright 2010 Google Inc. All Rights Reserved.
// Generated by ${generator}

package io.grpc.monitoring.streamz.utils;

import com.google.common.base.Function;
import com.google.common.collect.Iterables;
import com.google.common.collect.Maps;
import io.grpc.monitoring.streamz.Counter0;
import io.grpc.monitoring.streamz.Counter1;
import io.grpc.monitoring.streamz.Counter10;
import io.grpc.monitoring.streamz.Counter2;
import io.grpc.monitoring.streamz.Counter3;
import io.grpc.monitoring.streamz.Counter4;
import io.grpc.monitoring.streamz.Counter5;
import io.grpc.monitoring.streamz.Counter6;
import io.grpc.monitoring.streamz.Counter7;
import io.grpc.monitoring.streamz.Counter8;
import io.grpc.monitoring.streamz.Counter9;
import io.grpc.monitoring.streamz.Distribution;
import io.grpc.monitoring.streamz.EventMetric0;
import io.grpc.monitoring.streamz.EventMetric1;
import io.grpc.monitoring.streamz.EventMetric10;
import io.grpc.monitoring.streamz.EventMetric2;
import io.grpc.monitoring.streamz.EventMetric3;
import io.grpc.monitoring.streamz.EventMetric4;
import io.grpc.monitoring.streamz.EventMetric5;
import io.grpc.monitoring.streamz.EventMetric6;
import io.grpc.monitoring.streamz.EventMetric7;
import io.grpc.monitoring.streamz.EventMetric8;
import io.grpc.monitoring.streamz.EventMetric9;
import io.grpc.monitoring.streamz.Field;
import io.grpc.monitoring.streamz.GenericMetric;
import io.grpc.monitoring.streamz.Metric0;
import io.grpc.monitoring.streamz.Metric1;
import io.grpc.monitoring.streamz.Metric10;
import io.grpc.monitoring.streamz.Metric2;
import io.grpc.monitoring.streamz.Metric3;
import io.grpc.monitoring.streamz.Metric4;
import io.grpc.monitoring.streamz.Metric5;
import io.grpc.monitoring.streamz.Metric6;
import io.grpc.monitoring.streamz.Metric7;
import io.grpc.monitoring.streamz.Metric8;
import io.grpc.monitoring.streamz.Metric9;
import io.grpc.monitoring.streamz.MetricFactory;
import io.grpc.monitoring.streamz.VirtualMetric0;
import io.grpc.monitoring.streamz.VirtualMetric1;
import io.grpc.monitoring.streamz.VirtualMetric2;
import io.grpc.monitoring.streamz.VirtualMetric3;
import io.grpc.monitoring.streamz.VirtualMetric4;
import io.grpc.monitoring.streamz.VirtualMetric5;
import io.grpc.monitoring.streamz.VirtualMetric6;
import io.grpc.monitoring.streamz.VirtualMetric7;
import io.grpc.ManagedChannel;
// import com.google.net.rpc3.client.RpcChannel;
// import com.google.net.rpc3.client.RpcStubParameters;

import java.util.Map;

import javax.annotation.Generated;

/**
 * Utility for testing that {@code Metric}s are updated appropriately.
 * StreamzTester can test values of metrics either in-process, or in a
 * remote process, using {@link RemoteMetricReader}.
 *
 * <p>Additional documentation can be found at the Google Site at the <a href=
 * "https://sites.google.com/a/google.com/monarch-users/development/streamz-java-testing-cookbook">
 * Streamz Java Testing API</a>
 *
 * @author ecurran@google.com (Eoin Curran)
 */
@Generated(value = "${generator}")
public class StreamzTester {

  private final Map<Class<? extends Enum<?>>, Function<String, ? extends Enum<?>>> enumTranslators =
      Maps.newIdentityHashMap();
  private final MetricReader reader;

  /**
   * Creates a tester using a supplied MetricReader.
   */
  private StreamzTester(MetricReader reader) {
    this.reader = reader;
  }

  /**
   * Creates a tester, using streamz values in-process.
   */
  private StreamzTester() {
    this(new LocalMetricReader());
  }

  /**
   * Creates a tester, using streamz values in-process created by the supplied factory.
   */
  private StreamzTester(MetricFactory factory) {
    this(new LocalMetricReader(factory));
  }

  /**
   * Creates a StreamzTester that speaks to the Stubby service defined by the supplied serverSpec.
   */
  public static StreamzTester createRemoteTester(String serverSpec) {
    return new StreamzTester(new RemoteMetricReader(serverSpec));
  }

  /**
   * Creates a StreamzTester that speaks to the Stubby service at the supplied host and port.
   */
  public static StreamzTester createRemoteTester(String host, int port) {
    return new StreamzTester(new RemoteMetricReader(host, port));
  }

  /**
   * Creates a StreamzTester that speaks to the Stubby service on the supplied channel.
   */
  public static StreamzTester createRemoteTester(ManagedChannel channel) {
    return new StreamzTester(new RemoteMetricReader(channel));
  }

  /**
   * Creates a StreamzTester that speaks to the in-process metrics created by the supplied factory.
   *
   * @see MetricFactory
   * @see io.grpc.monitoring.streamz.TestMetricFactory
   */
  public static StreamzTester createLocalTester(MetricFactory factory) {
    return new StreamzTester(new LocalMetricReader(factory));
  }

  /**
   * Creates a StreamzTester that speaks to the in-process metrics created by the default factory.
   *
   * @see MetricFactory
   * @see MetricFactory#getDefault()
   */
  public static StreamzTester createLocalTesterForDefaultFactory() {
    return new StreamzTester();
  }

  /**
   * Map an enum to a class that restores values to their original enum type.
   *
   * <p>In most cases, it's possible to restore the original enum value from a snapshot by
   * using the inverse of the Enum's {@code toString} method. However in the case where the
   * specific enum class overrides toString, the enum can't be reverse identified. In those cases,
   * the tester can provide an inversion function, turning Strings to their original enum
   * values.
   *
   * <p>Keep in mind that this API applies to metric <i>values</i> only, and does not
   * apply to metric fields. Enum fields are dealt with using {@link
   * io.grpc.monitoring.streamz.Field#ofEnumAsString(Class, String)}.
   *
   * @param cls the enum class to be supported. Calling this method repeatedly with the same
   * class will replace all previously defined translators.
   * @param function a function that restores an enum from its {@link Enum#toString()} form.
   * Passing {@code null} indicates that the class has no translator.
   *
   * @return this object, allowing method chaining.
   */
  public <T extends Enum<T>> StreamzTester addEnumTranslator(
      Class<T> cls, Function<String, T> function) {
    enumTranslators.put(cls, function);
    return this;
  }

  /**
   * Get the enum translator assocaited with this tester.
   */
  @SuppressWarnings("unchecked") // addEnumTranslator ensures the typecast is safe.
  <T extends Enum<T>> Function<String, T> getEnumTranslator(Class<T> c) {
    return (Function<String, T>) enumTranslators.get(c);
  }

  /**
   * Reads a snapshot of Streamz metrics matching the given pattern.
   *
   * @param pattern If pattern ends in a '/', then it will match all metrics
   *     with that prefix. Otherwise it matches metrics with exactly that name.
   */
  public StreamzSnapshot getSnapshot(String pattern) {
    return reader.snapshot(pattern);
  }

  /**
   * Reads a snapshot of all Streamz metrics.
   */
  public StreamzSnapshot getFullSnapshot() {
    return reader.snapshotAll();
  }

  /**
   * Creates a metric tester for a named metric.
   *
   * <p> <b>Important</b> When the metric's value type
   * {@code Integer}, use {@code Long} here. That's because the collection mechanism doesn't
   * distinguish between 32- and 64-bit integers, so the fact that the metric was an {@code
   * Integer} is long gone by the time this reference gets a hold of it.
   *
   * @param metricName name of the metric to create a tester for.
   * @param valueType the value type of the metric.
   */
  public <V> MetricReferenceTester0<V> metricReference(
      String metricName,
      Class<V> valueType) {
    return new MetricReferenceTester0<V>(this, metricName, valueType);
  }

  /**
   * Creates a metric tester for a single-cell event metric.
   *
   * @param metricName The name of the metric to create the tester for.
   */
  public MetricReferenceTester0<Distribution> eventMetricReference(
      String metricName) {
    return new MetricReferenceTester0<Distribution>(
        this, metricName, Distribution.class);
  }

  private <V, M extends GenericMetric<V, M>> MetricReferenceTester0<V> referenceToImpl0(
      GenericMetric<V, M> metric) {
    return new MetricReferenceTester0<V>(this, metric.getName(), metric.getValueType());
  }

  /**
   * Creates a metric tester for a specific metric.
   *
   * @param metric the metric to create a tester for.
   */
  public <V> MetricReferenceTester0<V> referenceTo(Metric0<V> metric) {
    return referenceToImpl0(metric);
  }

  /**
   * Creates a metric tester for a specific event metric.
   *
   * @param metric the metric to create a tester for.
   */
  public MetricReferenceTester0<Distribution> referenceTo(EventMetric0 metric) {
    // Can't use referenceToImpl because getUnderlyingMetric() is protected.
    return new MetricReferenceTester0<Distribution>(this, metric.getName(), Distribution.class);
  }

  /**
   * Creates a metric tester for a specific counter.
   *
   * @param metric the metric to create a tester for.
   */
  public MetricReferenceTester0<Long> referenceTo(Counter0 metric) {
    return referenceToImpl0(metric);
  }

  /**
   * Creates a metric tester for a specific virtual metric.
   *
   * @param metric the metric to create a tester for.
   */
  public <V> MetricReferenceTester0<V> referenceTo(VirtualMetric0<V> metric) {
    return referenceToImpl0(metric);
  }

${factory_methods}
}